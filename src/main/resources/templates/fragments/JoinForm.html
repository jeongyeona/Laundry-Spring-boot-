<!-- src/main/resources/templates/fragments/JoinForm.html -->
<div th:fragment="JoinForm">
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>회원가입</title>
  <!-- Bootstrap CSS -->
  <link th:href="@{https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css}" rel="stylesheet"
        integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous"/>
  <!-- Custom CSS -->
  <link rel="stylesheet" th:href="@{/css/nav.css}"/>
  <link rel="stylesheet" th:href="@{/css/subnav.css}"/>
  <link rel="stylesheet" th:href="@{/css/subFooter.css}"/>
  <script th:src="@{//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js}" defer></script>
  <style>
    #container_form { text-align: left; display: none; padding: 2rem; }
    .invalid-feedback { display: none; color: #dc3545; }
    .is-invalid + .invalid-feedback { display: block; }
  </style>
</head>
<body>
<!-- 네비게이션 -->
<div th:insert="fragments/nav :: nav"></div>

<!-- 서브 네비게이션 -->
<div th:insert="fragments/subnav :: subnav('signup','signup')"></div>

<!-- 회원가입 폼 -->
<div id="container_form" class="container" th:fragment="JoinForm">
  <form th:action="@{/Signup}" method="post" id="signupForm" autocomplete="off">
    <!-- 이름 -->
    <div class="mb-3">
      <input name="name" id="name" class="form-control" type="text" placeholder="이름" required />
      <div class="invalid-feedback">이름을 입력해주세요.</div>
    </div>
    <!-- 이메일 -->
    <div class="mb-4">
      <input name="email" id="email" class="form-control" type="email" placeholder="name@example.com" required />
      <div class="invalid-feedback">이메일 형식에 맞게 입력하세요.</div>
    </div>
    <hr/>
    <!-- 아이디 -->
    <div class="mb-2 mt-4">
      <input name="id" id="id" class="form-control" type="text" maxlength="10"
             placeholder="아이디 (영문자+숫자 5~10자)" required />
      <div class="invalid-feedback">사용할 수 없는 아이디 입니다.</div>
    </div>
    <!-- 비밀번호 -->
    <div class="mb-3">
      <input name="pwd" id="pwd" class="form-control" type="password" maxlength="13"
             placeholder="비밀번호 (영문자,숫자,특수문자 포함 8~13자)" required />
      <div class="invalid-feedback">영문자, 숫자, 특수문자 포함 8~13자로 입력하세요.</div>
    </div>
    <div class="mb-4">
      <input name="pwd2" id="pwd2" class="form-control" type="password" maxlength="13"
             placeholder="비밀번호 확인" required />
      <div class="invalid-feedback">비밀번호가 일치하지 않습니다.</div>
    </div>
    <hr/>
    <!-- 주소 -->
    <div class="mb-4">
      <div class="row g-2 mb-2">
        <div class="col-auto">
          <input name="postcode" id="postcode" class="form-control" type="text" placeholder="우편번호" readonly />
        </div>
        <div class="col-auto">
          <button type="button" class="btn btn-dark" onclick="execDaumPostcode()">우편번호 찾기</button>
        </div>
      </div>
      <div class="mb-2">
        <input name="addr" id="addr" class="form-control" type="text" placeholder="주소" readonly />
      </div>
      <div class="row g-2 mb-2">
        <div class="col-auto">
          <input name="detailAddr" id="detailAddr" class="form-control" type="text" maxlength="25"
                 placeholder="상세주소" required />
          <div class="invalid-feedback">상세주소를 입력해주세요.</div>
        </div>
        <div class="col-auto">
          <input name="extraAddr" id="extraAddr" class="form-control" type="text" placeholder="참고항목" readonly />
        </div>
      </div>
      <input type="hidden" name="totalAddr" id="totalAddr" />
    </div>
    <hr/>
    <!-- 국가코드 -->
    <div class="mb-3">
      <select name="countryCode">
        <option th:each="c : ${countryCodes}"
                th:value="${c.dialCode}"
                th:text="${c.countryName + ' (+' + c.dialCode + ')'}">
        </option>
      </select>
    </div>
    <!-- 전화번호 -->
    <div class="mb-3">
      <input name="phone" id="phone" class="form-control" type="text" maxlength="11"
             placeholder="전화번호 (숫자만)" required />
      <div class="invalid-feedback">올바른 전화번호를 입력하세요.</div>
    </div>
    <!-- 가입 버튼 -->
    <div class="d-flex justify-content-center">
      <button type="submit" class="btn btn-dark">가입</button>
    </div>
  </form>
</div>

<!-- Bootstrap JS & Daum Postcode -->
<script th:src="@{https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js}"></script>
<script th:inline="javascript">
  // Daum 우편번호 팝업
    function execDaumPostcode(){
      new daum.Postcode({ oncomplete(data) {
        let addr = data.userSelectedType==='R'? data.roadAddress: data.jibunAddress;
        let extra = '';
        if (data.userSelectedType==='R') {
          if (data.bname && /[동|로|가]$/.test(data.bname)) extra+=data.bname;
          if (data.buildingName && data.apartment==='Y')
            extra += (extra? ', '+data.buildingName : data.buildingName);
          if (extra) extra = '('+extra+')';
        }
        document.getElementById('postcode').value = data.zonecode;
        document.getElementById('addr').value     = addr;
        document.getElementById('extraAddr').value= extra;
        isAddrValid01 = true;
      }}).open();
    }
    window.execDaumPostcode = execDaumPostcode;

  /*<![CDATA[*/
    // 유효성 플래그
    let isNameValid=false, isIdValid=false, isPwdValid=false,
        isEmailValid=false, isPhoneValid=false,
        isAddrValid01=false, isAddrValid02=false;

    // 이름 검증
    document.getElementById('name').addEventListener('input', function(){
      isNameValid = /^[가-힣]+$/.test(this.value);
      this.classList.toggle('is-valid', isNameValid);
      this.classList.toggle('is-invalid', !isNameValid);
    });

    // 아이디 중복검사
    document.getElementById('id').addEventListener('input', function(){
      const el=this;
      const v=el.value;
      el.classList.remove('is-valid','is-invalid');
      if(!/^[a-z].{4,9}$/.test(v)){ isIdValid=false; el.classList.add('is-invalid'); return; }
      fetch(/*[[@{/users/checkid}]]*/ + '?inputId='+v)
        .then(r=>r.json())
        .then(d=>{
          isIdValid = !d.isExist;
          el.classList.toggle('is-valid', isIdValid);
          el.classList.toggle('is-invalid', !isIdValid);
        });
    });

    // 비밀번호 확인
    function checkPwd(){
      const p=document.getElementById('pwd').value;
      const p2=document.getElementById('pwd2').value;
      const reg = /^(?=.*[A-Za-z])(?=.*\\d)(?=.*[@$!%*#?&^]).{8,13}$/;
      const ok = reg.test(p) && p===p2;
      isPwdValid = ok;
      ['pwd','pwd2'].forEach(id=>{
        const i=document.getElementById(id);
        i.classList.toggle('is-valid', ok);
        i.classList.toggle('is-invalid', !ok);
      });
    }
    ['pwd','pwd2'].forEach(id=>document.getElementById(id).addEventListener('input',checkPwd));

    // 이메일 검증
    document.getElementById('email').addEventListener('input', function(){
      isEmailValid = /@/.test(this.value);
      this.classList.toggle('is-valid', isEmailValid);
      this.classList.toggle('is-invalid', !isEmailValid);
    });

    // 전화번호 검증
    document.getElementById('phone').addEventListener('input', function(){
      this.value = this.value.replace(/[^0-9]/g,'');
      isPhoneValid = /^01[016789]\\d{7,8}$/.test(this.value);
      this.classList.toggle('is-valid', isPhoneValid);
      this.classList.toggle('is-invalid', !isPhoneValid);
    });

    // 상세주소 입력 확인
    document.getElementById('detailAddr').addEventListener('input', function(){
      isAddrValid02 = this.value.trim().length>0;
      this.classList.toggle('is-valid', isAddrValid02);
      this.classList.toggle('is-invalid', !isAddrValid02);
    });

    // 폼 제출 전 최종 검증
    document.getElementById('signupForm').addEventListener('submit', function(e){
      const valid = isNameValid && isIdValid && isPwdValid
                  && isEmailValid && isPhoneValid
                  && isAddrValid01 && isAddrValid02;
      if(!valid){
        e.preventDefault();
        alert('입력하신 정보를 다시 확인해주세요.');
      } else {
        document.getElementById('totalAddr').value =
          [document.getElementById('postcode').value,
           document.getElementById('addr').value,
           document.getElementById('detailAddr').value,
           document.getElementById('extraAddr').value].join('_');
      }
    });
  /*]]>*/
</script>
</body>
</html>
